



<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
<meta name="referrer" content="no-referrer">
<meta name="baidu-site-verification" content="code-dglt80cYFf">
<meta name="msvalidate.01" content="5E35A151E828ADCA8EF9987425299BC8">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">


<link rel="alternate" type="application/rss+xml" title="寂林的小窝" href="https://jilinjl.github.io/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="寂林的小窝" href="https://jilinjl.github.io/atom.xml" />
<link rel="alternate" type="application/json" title="寂林的小窝" href="https://jilinjl.github.io/feed.json" />

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  
  <meta name="keywords" content="JS" />


<link rel="canonical" href="https://jilinjl.github.io/js/js-basic/The%20Super%20Tiny%20Complier/">



  <title>
迷你编译器 - JS基础 - JavaScript |
Welcome = 寂林的小窝 = JiLin's Cave</title>
<meta name="generator" content="Hexo 5.4.2"></head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
  </div>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">迷你编译器
  </h1>
  
<div class="meta">
  <span class="item" title="创建时间：2023-03-24 00:00:00">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">发表于</span>
    <time itemprop="dateCreated datePublished" datetime="2023-03-24T00:00:00+08:00">2023-03-24</time>
  </span>
  <span class="item" title="本文字数">
    <span class="icon">
      <i class="ic i-pen"></i>
    </span>
    <span class="text">本文字数</span>
    <span>21k</span>
    <span class="text">字</span>
  </span>
  <span class="item" title="阅读时长">
    <span class="icon">
      <i class="ic i-clock"></i>
    </span>
    <span class="text">阅读时长</span>
    <span>19 分钟</span>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="切换导航栏">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">Welcome</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
        <ul>
          <li class="item" data-background-image="http://imgapi.xl0408.top/index.php?826372"></li>
          <li class="item" data-background-image="http://imgapi.xl0408.top/index.php?44638"></li>
          <li class="item" data-background-image="http://imgapi.xl0408.top/index.php?79340"></li>
          <li class="item" data-background-image="http://imgapi.xl0408.top/index.php?540133"></li>
          <li class="item" data-background-image="http://imgapi.xl0408.top/index.php?699866"></li>
          <li class="item" data-background-image="http://imgapi.xl0408.top/index.php?470579"></li>
        </ul>
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
<i class="ic i-home"></i>
<span><a href="/">首页</a></span><i class="ic i-angle-right"></i>
<span  itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/js/" itemprop="item" rel="index" title="分类于 JavaScript"><span itemprop="name">JavaScript</span></a>
<meta itemprop="position" content="1" /></span>
<i class="ic i-angle-right"></i>
<span  class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/js/js-basic/" itemprop="item" rel="index" title="分类于 JS基础"><span itemprop="name">JS基础</span></a>
<meta itemprop="position" content="2" /></span>
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN">
  <link itemprop="mainEntityOfPage" href="https://jilinjl.github.io/js/js-basic/The%20Super%20Tiny%20Complier/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/avatar.jpg">
    <meta itemprop="name" content="寂林">
    <meta itemprop="description" content="JiLin's Cave, 飒飒西风满院栽,蕊寒香冷蝶难来">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="寂林的小窝">
  </span>


        <!-- 不蒜子统计 -->
        <span id="busuanzi_container_page_pv" style='display:none' class="<%= class_name %>">
              <i class="icon-smile icon"></i> 阅读数：<span id="busuanzi_value_page_pv"></span>次
        </span>


  <div class="body md" itemprop="articleBody">
    

    <h1 id="the-super-tiny-complier"><a class="markdownIt-Anchor" href="#the-super-tiny-complier">#</a> The Super Tiny Complier</h1>
<p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2phbWllYnVpbGRzL3RoZS1zdXBlci10aW55LWNvbXBpbGVy">github 地址</span><br>
翻译：有道词典</p>
<p>今天我们将一起来写一个编译器，但不是什么普通的编译器… 而是一个超级小的编译器！<br>
 如果你删掉所有注释，该文件将只剩下大约 200 行实际代码</p>
<p>我们将把一些类似<em>含糊不清</em> 的函数调用编译成一些 C 语言风格的函数调用</p>
<p>如果你对其中一个不熟悉，我来简单介绍一下</p>
<p><strong>如果我们有两个函数 “加” 和 “减”，它们可以写成这样:</strong></p>
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">LISP</th>
<th style="text-align:center">C</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">2 + 2</td>
<td style="text-align:center">(add 2 2)</td>
<td style="text-align:center">add(2, 2)</td>
</tr>
<tr>
<td style="text-align:center">4 - 2</td>
<td style="text-align:center">(subtract 4 2)</td>
<td style="text-align:center">subtract(4, 2)</td>
</tr>
<tr>
<td style="text-align:center">2 + (4 - 2)</td>
<td style="text-align:center">(add 2 (subtract 4 2))</td>
<td style="text-align:center">add(2, subtract(4, 2))</td>
</tr>
</tbody>
</table>
<p>小菜一碟，对吧？</p>
<p><strong>很好，因为这正是我们要编译的，虽然这不是一个完整的 LISP 或者 C 语法，但它的语法足以演示现代编译器的许多主要部分</strong></p>
<p><strong>大多数编译器分为三个主要阶段：解析、转换和代码生成</strong></p>
<ul>
<li>请记住三个主要阶段，它们是编译器的核心！</li>
</ul>
<ol>
<li>
<p><em><strong>Parsing</strong></em> is taking raw code and turning it into a more abstract representation of the code.</p>
</li>
<li>
<p><em><strong>Transformation</strong></em> takes this abstract representation and manipulates to do whatever the compiler wants it to.</p>
</li>
<li>
<p><em><strong>Code Generation</strong></em> takes the transformed representation of the code and turns it into new code.</p>
</li>
<li>
<p><em><strong>解析</strong></em> 是获取原始代码并将其转换为更抽象的代码表示。</p>
</li>
<li>
<p><em><strong>转化</strong></em> 拿到抽象的表示和操作来执行编译器希望它执行的任何操作。</p>
</li>
<li>
<p><em><strong>代码生成</strong></em> 获取转化后的代码，将其转换为新的代码。</p>
</li>
</ol>
<h2 id="parsing-解析"><a class="markdownIt-Anchor" href="#parsing-解析">#</a> <strong>Parsing</strong> 解析</h2>
<p>解析通常被划分为两个阶段:  <code>词法分析</code>  和  <code>语法分析</code></p>
<hr>
<ol>
<li>
<p><em>词法分析</em> <code> lexical analysis</code>  获取原始代码，并通过一个称为标记器 (或词法分析器) 的东西将其拆分为  <code>tokens</code> 。</p>
<p><code>token</code>  是一组微小的对象，用来描述语法中一个孤立的片段，它可以是数字、标签、标点、运算符等等。</p>
</li>
<li>
<p><em>语法分析</em>  获取到 ``token <code>并将它们重新格式化为 描述语法的每个部分极其相互关系 的表示。这被称为中间表示或抽象语法树。（Abstract Syntax Tree）  </code> AST` 是一个嵌套很深的对象，它以一种既易于使用又能告诉我们大量信息的方式表示代码。</p>
</li>
</ol>
<hr>
<p>对于以下的语法:</p>
<p>( add 2 (subtract 4 2 ) )</p>
<p><code>tokens</code>  可能看起来像这样:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123; <span class="attr">type</span>: <span class="string">&#x27;paren&#x27;</span>,  <span class="attr">value</span>: <span class="string">&#x27;(&#x27;</span>        &#125;,</span><br><span class="line">  &#123; <span class="attr">type</span>: <span class="string">&#x27;name&#x27;</span>,   <span class="attr">value</span>: <span class="string">&#x27;add&#x27;</span>      &#125;,</span><br><span class="line">  &#123; <span class="attr">type</span>: <span class="string">&#x27;number&#x27;</span>, <span class="attr">value</span>: <span class="string">&#x27;2&#x27;</span>        &#125;,</span><br><span class="line">  &#123; <span class="attr">type</span>: <span class="string">&#x27;paren&#x27;</span>,  <span class="attr">value</span>: <span class="string">&#x27;(&#x27;</span>        &#125;,</span><br><span class="line">  &#123; <span class="attr">type</span>: <span class="string">&#x27;name&#x27;</span>,   <span class="attr">value</span>: <span class="string">&#x27;subtract&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">type</span>: <span class="string">&#x27;number&#x27;</span>, <span class="attr">value</span>: <span class="string">&#x27;4&#x27;</span>        &#125;,</span><br><span class="line">  &#123; <span class="attr">type</span>: <span class="string">&#x27;number&#x27;</span>, <span class="attr">value</span>: <span class="string">&#x27;2&#x27;</span>        &#125;,</span><br><span class="line">  &#123; <span class="attr">type</span>: <span class="string">&#x27;paren&#x27;</span>,  <span class="attr">value</span>: <span class="string">&#x27;)&#x27;</span>        &#125;,</span><br><span class="line">  &#123; <span class="attr">type</span>: <span class="string">&#x27;paren&#x27;</span>,  <span class="attr">value</span>: <span class="string">&#x27;)&#x27;</span>        &#125;,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p><code>AST</code>  可能看起来像这样</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="string">&#x27;Program&#x27;</span>,</span><br><span class="line">  <span class="attr">body</span>: [&#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="string">&#x27;CallExpression&#x27;</span>,</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;add&#x27;</span>,</span><br><span class="line">    <span class="attr">params</span>: [&#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;NumberLiteral&#x27;</span>,</span><br><span class="line">      <span class="attr">value</span>: <span class="string">&#x27;2&#x27;</span>,</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;CallExpression&#x27;</span>,</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;subtract&#x27;</span>,</span><br><span class="line">      <span class="attr">params</span>: [&#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;NumberLiteral&#x27;</span>,</span><br><span class="line">        <span class="attr">value</span>: <span class="string">&#x27;4&#x27;</span>,</span><br><span class="line">      &#125;, &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;NumberLiteral&#x27;</span>,</span><br><span class="line">        <span class="attr">value</span>: <span class="string">&#x27;2&#x27;</span>,</span><br><span class="line">      &#125;]</span><br><span class="line">    &#125;]</span><br><span class="line">  &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="transformation-转化"><a class="markdownIt-Anchor" href="#transformation-转化">#</a> <strong>Transformation</strong> 转化</h2>
<hr>
<p>编译的下一个阶段就是转化，它从上一步获取到 AST 并对其进行更改，它可以用同一种语言操作 AST, 也可以将其翻译成一种全新的语言。</p>
<p>让我们来看看如何转化 AST</p>
<p>您可能会注意到，AST 中的元素看起来非常相似。都是带着 type 属性的对象。每一个都被称为 AST 节点。这些节点上定义了描述树的一个独立部分的属性。</p>
<p>我们可以为 &quot;NumberLiteral&quot; 创建一个节点</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="string">&#x27;NumberLiteral&#x27;</span>,</span><br><span class="line">  <span class="attr">value</span>: <span class="string">&#x27;2&#x27;</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>或者为 “CallExpression” 创建</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="string">&#x27;CallExpression&#x27;</span>,</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;subtract&#x27;</span>,</span><br><span class="line">  <span class="attr">params</span>: [...nested nodes go here...],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>在转换 AST 时，我们可以通过添加 / 删除 / 替换属性来操作节点，我们可以添加新节点，删除节点，或者我们可以不影响现有 AST，并在其基础上创建一个全新的 AST。</strong></p>
<p><strong>因为我们的目标是一个新语言，所以我们将要专注于创建一个全新的，特定于目标语言的 AST.</strong></p>
<h3 id="traversal-遍历"><a class="markdownIt-Anchor" href="#traversal-遍历">#</a> Traversal  遍历</h3>
<p>为了能够浏览到所有的节点，我们需要遍历他们，这个遍历到达每个节点的过程采用<strong>深度优先</strong>，</p>
<p>例如:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="string">&#x27;Program&#x27;</span>,</span><br><span class="line">  <span class="attr">body</span>: [&#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="string">&#x27;CallExpression&#x27;</span>,</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;add&#x27;</span>,</span><br><span class="line">    <span class="attr">params</span>: [&#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;NumberLiteral&#x27;</span>,</span><br><span class="line">      <span class="attr">value</span>: <span class="string">&#x27;2&#x27;</span></span><br><span class="line">    &#125;, &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;CallExpression&#x27;</span>,</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;subtract&#x27;</span>,</span><br><span class="line">      <span class="attr">params</span>: [&#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;NumberLiteral&#x27;</span>,</span><br><span class="line">        <span class="attr">value</span>: <span class="string">&#x27;4&#x27;</span></span><br><span class="line">      &#125;, &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;NumberLiteral&#x27;</span>,</span><br><span class="line">        <span class="attr">value</span>: <span class="string">&#x27;2&#x27;</span></span><br><span class="line">      &#125;]</span><br><span class="line">    &#125;]</span><br><span class="line">  &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于以上 AST, 我们这样执行:</p>
<blockquote>
<ol>
<li><code>Program</code>  - 从 AST 顶级节点开始</li>
<li><code>CallEXpression (add)</code>  - 访问到<em> Program</em> 节点的第一个 body 节点</li>
<li><code>NumberLiteral (2)</code>  - 移动到<em> CallExpression</em> 节点的第一个 params 节点</li>
<li><code>CallExpression (subtract)</code>  -  移动到<em> CallExpression</em> 的第二个 params 节点</li>
<li><code>NumberLiteral (4)</code>  - 移动到<em> CallExpression</em> 的第一个 params 节点</li>
<li><code>NumberLiteral (2)</code>  - 移动到<em> CallExpression</em> 的第二个 params 节点</li>
</ol>
</blockquote>
<p>如果我们直接操作这个 AST，而不是创建一个单独的 AST，我们可能会在这里引入各种抽象。但对于我们需要做的而言，只要 <code>访问</code> 树中的每个节点就足够了。</p>
<p>这里用到  <code>visite(访问)</code>  一词是因为存在这样一种设计模式来表示对对象结构元素的操作。</p>
<blockquote>
<p>** 访问器模式（Visitor Pattern）** 又称为访问者模式或访问者设计模式，是一种行为型设计模式，它允许你将算法插入到现有对象结构中的各个对象中，从而改变它们的行为。访问器模式使得你可以在不改变各个对象的类的前提下定义作用于这些对象的新操作。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">name, age, height</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">age</span> = age;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">height</span> = height;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">accept</span>(<span class="params">visitor</span>) &#123;</span><br><span class="line">    visitor.<span class="title function_">visit</span>(<span class="variable language_">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OutputVisitor</span> &#123;</span><br><span class="line">  <span class="title function_">visit</span>(<span class="params">person</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Name: <span class="subst">$&#123;person.name&#125;</span>, Age: <span class="subst">$&#123;person.age&#125;</span>, Height: <span class="subst">$&#123;person.height&#125;</span>`</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> person = <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&#x27;Tom&#x27;</span>, <span class="number">25</span>, <span class="number">180</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> outputVisitor = <span class="keyword">new</span> <span class="title class_">OutputVisitor</span>();</span><br><span class="line">person.<span class="title function_">accept</span>(outputVisitor); <span class="comment">// 输出：Name: Tom, Age: 25, Height: 180</span></span><br></pre></td></tr></table></figure>
<p>在上面的例子中，我们定义了一个 <code>Person</code>  类和一个 <code>OutputVisitor</code>  类。 <code>Person</code>  类中有 <code>accept</code>  方法，它接受一个 <code>visitor</code>  作为参数，并调用 <code>visitor.visit(this)</code>  方法来对当前对象进行访问。 <code>OutputVisitor</code>  类中定义了 <code>visit</code>  方法，用来操作 <code>Person</code>  对象的属性，并输出结果。</p>
<p>最后，我们创建了一个 <code>Person</code>  对象，并创建了一个 <code>OutputVisitor</code>  对象。我们调用 <code>person.accept(outputVisitor)</code>  方法来访问 <code>Person</code>  对象，并输出结果。</p>
</blockquote>
<h3 id="visitors-访问器"><a class="markdownIt-Anchor" href="#visitors-访问器">#</a> Visitors 访问器</h3>
<p>​	这里的基本思想是：我们将要创建一个 <code>visitor</code>  对象，它有一个可以访问所有不同类型节点的方法。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> visitor = &#123;</span><br><span class="line">  <span class="title class_">NumberLiteral</span>() &#123;&#125;,</span><br><span class="line">  <span class="title class_">CallExpression</span>() &#123;&#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>​	当遍历 AST 时，只要 “输入” 匹配类型的节点，就会调用该访问器上的方法。</p>
<p>​	为了使这起作用，我们还将传递节点 <code>node</code>  和父节点的引用 <code>parent</code> 。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> visitor = &#123;</span><br><span class="line">  <span class="title class_">NumberLiteral</span>(node,parent) &#123;&#125;,</span><br><span class="line">  <span class="title class_">CallExpression</span>(node,parent) &#123;&#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​	然而，我们也需要考虑到事务 &quot;退出&quot; 的可能，想象一下我们之前列出的树结构</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- <span class="title class_">Program</span></span><br><span class="line">  - <span class="title class_">CallExpression</span></span><br><span class="line">    - <span class="title class_">NumberLiteral</span></span><br><span class="line">    - <span class="title class_">CallExpression</span></span><br><span class="line">      - <span class="title class_">NumberLiteral</span></span><br><span class="line">      - <span class="title class_">NumberLiteral</span></span><br></pre></td></tr></table></figure>
<p>​	当我们向下遍历的时候，我们会达到一些分支尽头。当我们完成遍历一个分支我们需要 &quot;退出&quot; 该分支。因此，沿着树向下走，我们 “进入” 每个节点，然后向上走，我们 “退出” 分支。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">-&gt; <span class="title class_">Program</span> (enter)</span><br><span class="line">  -&gt; <span class="title class_">CallExpression</span> (enter)</span><br><span class="line">    -&gt; <span class="title class_">Number</span> <span class="title class_">Literal</span> (enter)</span><br><span class="line">    &lt;- <span class="title class_">Number</span> <span class="title class_">Literal</span> (exit)</span><br><span class="line">    -&gt; <span class="title class_">Call</span> <span class="title class_">Expression</span> (enter)</span><br><span class="line">       -&gt; <span class="title class_">Number</span> <span class="title class_">Literal</span> (enter)</span><br><span class="line">       &lt;- <span class="title class_">Number</span> <span class="title class_">Literal</span> (exit)</span><br><span class="line">       -&gt; <span class="title class_">Number</span> <span class="title class_">Literal</span> (enter)</span><br><span class="line">       &lt;- <span class="title class_">Number</span> <span class="title class_">Literal</span> (exit)</span><br><span class="line">    &lt;- <span class="title class_">CallExpression</span> (exit)</span><br><span class="line">  &lt;- <span class="title class_">CallExpression</span> (exit)</span><br><span class="line">&lt;- <span class="title class_">Program</span> (exit)</span><br></pre></td></tr></table></figure>
<p>为了支持这一点，我们最终的访问器应该是这样的</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> visitor = &#123;</span><br><span class="line">    <span class="title class_">NumberLiteral</span>: &#123;</span><br><span class="line">        <span class="title function_">enter</span>(<span class="params">node, parent</span>)&#123;&#125;,</span><br><span class="line">        <span class="title function_">exit</span>(<span class="params">node, parent</span>)&#123;&#125;,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="code-generation-代码生成"><a class="markdownIt-Anchor" href="#code-generation-代码生成">#</a> <strong>Code Generation</strong> 代码生成</h2>
<p>编译器的最后一个阶段就是代码生成，有时编译器会做一些与转换重叠的事情，但在大多数情况下，代码生成只是意味着取出我们的 AST 和字符串化代码。</p>
<p>代码生成器以几种不同的方式工作，一些编译器将重用之前的标记，其他编译器将创建一个单独的代码表示，以便它们可以线性打印节点，但据我所见，大多数编译器将使用我们刚刚创建的相同的 AST，这是我们将重点关注的内容。</p>
<p>实际上，我们的代码生成器知道如何 &quot; 打印” AST 的所有不同节点类型，并且它将递归地调用自身来打印嵌套的节点，直到所有内容都打印成一长串代码。</p>
<hr>	
<p><strong>总之，以上就是编译器的所有部分</strong></p>
<p>这并不是说所有编译器都看起来与我描述的完全一致，编译器有着许多不同的用途，它们需要的步骤可能比我所详细描述的要多.</p>
<p>但是现在你应该对大多数编译器长什么样子有一个通用的高级概念.</p>
<p>现在我已经解释了所有这些，您都可以编写自己的编译器了，对吗？</p>
<p>开个玩笑… 帮助你们实现一个编译器正是我的目的；🚩</p>
<h1 id="tiny-complier"><a class="markdownIt-Anchor" href="#tiny-complier">#</a> Tiny Complier</h1>
<h2 id="前方高能"><a class="markdownIt-Anchor" href="#前方高能">#</a> 前方高能！！</h2>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ============================================================================</span></span><br><span class="line"><span class="comment"> *                                   (/^▽^)/</span></span><br><span class="line"><span class="comment"> *                                THE TOKENIZER!</span></span><br><span class="line"><span class="comment"> * ============================================================================</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// 我们将从解析的第一阶段开始，使用`Tokenizers`的 `lexical analysis`词法分析。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//我们需要做的只是把字符串形式的代码划分成tokens数组</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">*   (add 2 (subtract 4 2))   =&gt;   [&#123; type: &#x27;paren&#x27;, value: &#x27;(&#x27; &#125;, ...]</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// tokennizer分析器</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">tokenizer</span>(<span class="params">input</span>)&#123;</span><br><span class="line">    <span class="comment">// 一个 current 变量作为指针跟踪我们当前位置</span></span><br><span class="line">    <span class="keyword">let</span> current = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 一个 tokens 数组收集所有tokens</span></span><br><span class="line">    <span class="keyword">let</span> tokens = [];</span><br><span class="line"></span><br><span class="line">    <span class="comment">//我们首先创建一个“while”循环，</span></span><br><span class="line">    <span class="comment">//在其中设置我们的“current”变量，</span></span><br><span class="line">    <span class="comment">//使其在循环“内部”随心所欲地递增。</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//我们这样做是因为我们可能想要在一个循环中多次增加 current</span></span><br><span class="line">    <span class="comment">//因为我们的tokens可以是任何长度。</span></span><br><span class="line">    <span class="keyword">while</span> (current &lt; input.<span class="property">length</span>)&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 我们还需要储存在input中,当前current指向的字符</span></span><br><span class="line">        <span class="keyword">let</span> char = input[current]</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 我们首先想要检查的是一个开括号, </span></span><br><span class="line">        <span class="comment">// 括号一会儿将用于 CallExpression</span></span><br><span class="line">        <span class="comment">// 但现在我们只关心字符</span></span><br><span class="line">        <span class="keyword">if</span>( char === <span class="string">&#x27;(&#x27;</span> )&#123;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 如果为真,我们push一个类型为 `paren` 的新token, 并设置为一个开括号</span></span><br><span class="line">            tokens.<span class="title function_">push</span>(&#123;</span><br><span class="line">                <span class="attr">type</span>: <span class="string">&#x27;paren&#x27;</span>,</span><br><span class="line">                <span class="attr">value</span>: <span class="string">&#x27;(&#x27;</span>,</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 然后current指针移动</span></span><br><span class="line">            current++;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 然后继续下一轮循环,相当于已记录为&#x27;(&#x27;,去下一个字符</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 接下来我们检查闭括号,和上面一样</span></span><br><span class="line">        <span class="keyword">if</span>( char ===<span class="string">&#x27;)&#x27;</span> )&#123;</span><br><span class="line">            tokens.<span class="title function_">push</span>(&#123;</span><br><span class="line">                <span class="attr">type</span>: <span class="string">&#x27;paren&#x27;</span>,</span><br><span class="line">                <span class="attr">value</span>: <span class="string">&#x27;)&#x27;</span>,</span><br><span class="line">            &#125;)</span><br><span class="line"></span><br><span class="line">            current++;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 继续, 我们现在来检查空格, 这很有趣，因为我们关心空格是否存在 用于分隔字符，</span></span><br><span class="line">        <span class="comment">// 但将其存储为令牌实际上并不重要。我们只会在以后把它扔掉。</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 因此, 我们只需要测试空格是否存在,然后continue,并不需要存入tokens</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable constant_">WHITESPACE</span> = <span class="regexp">/\s/</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable constant_">WHITESPACE</span>.<span class="title function_">test</span>(char))&#123;</span><br><span class="line">            current ++;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 下一种类型的令牌是number。这与我们之前看到的不同，</span></span><br><span class="line">        <span class="comment">// 因为一个数字可以是任意数量的字符，我们希望将整个字符序列捕获为一个令牌。</span></span><br><span class="line">        <span class="comment">/* (add 123 456)</span></span><br><span class="line"><span class="comment">                ^^^ ^^^</span></span><br><span class="line"><span class="comment">                Only two separate tokens</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//因此我们需要从遇到序列中的第一个number开始</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable constant_">NUMBERS</span> = <span class="regexp">/[0-9]/</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable constant_">NUMBERS</span>.<span class="title function_">test</span>(char))&#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//我们需要创建一个value字符串预存将要push的数据</span></span><br><span class="line">            <span class="keyword">let</span> value = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            <span class="comment">// 然后，我们将循环序列中的每个字符，直到遇到一个不是数字的字符，</span></span><br><span class="line">            <span class="comment">// 将每个是数字的字符推到我们的“值”，并在此过程中current++。</span></span><br><span class="line">            <span class="keyword">while</span>(<span class="variable constant_">NUMBERS</span>.<span class="title function_">test</span>(char))&#123;</span><br><span class="line">                value += char;</span><br><span class="line">                current++;</span><br><span class="line">                char = input[current]</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 最后我们把number加入到tokens数组</span></span><br><span class="line">            tokens.<span class="title function_">push</span>(&#123;</span><br><span class="line">                <span class="attr">type</span>: <span class="string">&#x27;number&#x27;</span>,</span><br><span class="line">                value</span><br><span class="line">            &#125;)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 我们还将添加语言中对字符串的支持,即任何被 &quot;&quot; 包裹的字符串</span></span><br><span class="line">        <span class="comment">/*(concat &quot;foo&quot; &quot;bar&quot;)</span></span><br><span class="line"><span class="comment">                   ^^^   ^^^ string tokens</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">       <span class="comment">// 我们需要检查双引号的开始</span></span><br><span class="line">       <span class="keyword">if</span>(char ===<span class="string">&#x27;&quot;&#x27;</span> )&#123;</span><br><span class="line">            <span class="comment">//维护一个value变量预存数据</span></span><br><span class="line">            <span class="keyword">let</span> value = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 在tokens中跳过开头的&quot;,不存储进去</span></span><br><span class="line">            char = input[++current];</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 然后开始遍历每个字符直到遇到另一个双引号</span></span><br><span class="line">            <span class="keyword">while</span>(char != <span class="string">&#x27;&quot;&#x27;</span>)&#123;</span><br><span class="line">                value += char;</span><br><span class="line">                char = input[++current];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 同样,需要跳过最后的 &quot;,让current直接指向下一个char</span></span><br><span class="line">            char = input[++current];</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 最后把string加入到tokens数组</span></span><br><span class="line">            tokens.<span class="title function_">push</span>(&#123;</span><br><span class="line">                <span class="attr">type</span>: <span class="string">&#x27;string&#x27;</span>,</span><br><span class="line">                value</span><br><span class="line">            &#125;)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 最后一种类型的token是name, 这是一个由字母组成的序列</span></span><br><span class="line">        <span class="comment">// 它们是 lisp 语法中的函数名,如下</span></span><br><span class="line">        <span class="comment">/*(add 2 4)</span></span><br><span class="line"><span class="comment">            ^^^</span></span><br><span class="line"><span class="comment">            Name token</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="variable constant_">LETTERS</span> = <span class="regexp">/[a-z]/i</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable constant_">LETTERS</span>.<span class="title function_">test</span>(char))&#123;</span><br><span class="line">            <span class="keyword">let</span> value = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(<span class="variable constant_">LETTERS</span>.<span class="title function_">test</span>(char))&#123;</span><br><span class="line">                value += char;</span><br><span class="line">                char = input[++current];</span><br><span class="line">            &#125;</span><br><span class="line">        </span><br><span class="line">            tokens.<span class="title function_">push</span>(&#123;</span><br><span class="line">                <span class="attr">type</span>: <span class="string">&#x27;name&#x27;</span>,</span><br><span class="line">                value</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 最后如果到现在还没匹配到当前字符,将会抛出一个错误</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TypeError</span>(<span class="string">&#x27;I dont know what this character is:&#x27;</span> + char)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> tokens</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ============================================================================</span></span><br><span class="line"><span class="comment"> *                                 ヽ/❀o ل͜ o\ﾉ</span></span><br><span class="line"><span class="comment"> *                                THE PARSER!!!</span></span><br><span class="line"><span class="comment"> * ============================================================================</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// 接下来我们将要把tokens数组转化为AST抽象语法树</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">*   [&#123; type: &#x27;paren&#x27;, value: &#x27;(&#x27; &#125;, ...]   =&gt;   &#123; type: &#x27;Program&#x27;, body: [...] &#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">// parser解析器</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">parser</span>(<span class="params">tokens</span>)&#123;</span><br><span class="line">    <span class="comment">// 我们再次维护一个current变量作为指针</span></span><br><span class="line">    <span class="keyword">let</span> current = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 但是这次我们将要使用递归代替while循环,因此需要一个walk函数</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">walk</span>(<span class="params"></span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 在递归函数内我们从拿到current指向的token开始</span></span><br><span class="line">        <span class="keyword">let</span> token = tokens[current];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 我们将把每种类型的token划分到不同路径中,</span></span><br><span class="line">        <span class="comment">// 这里从number开始</span></span><br><span class="line">        <span class="comment">// 我们测试一下看看类型是否为number</span></span><br><span class="line">        <span class="keyword">if</span> (token.<span class="property">type</span> === <span class="string">&#x27;number&#x27;</span>)&#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 如果是,让current指向下一个token</span></span><br><span class="line">            current++;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 然后我们返回一个新的AST节点名叫&quot;NumberLiteral&quot;</span></span><br><span class="line">            <span class="comment">// 并且把token的value值附给他的value</span></span><br><span class="line">            <span class="keyword">return</span>&#123;</span><br><span class="line">                <span class="attr">type</span>: <span class="string">&#x27;NumberLiteral&#x27;</span>,</span><br><span class="line">                <span class="attr">value</span>: token.<span class="property">value</span>,</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果是string类型,则创建一个`StringLiteral`节点</span></span><br><span class="line">        <span class="keyword">if</span> (token.<span class="property">type</span> === <span class="string">&#x27;string&#x27;</span>)&#123;</span><br><span class="line">            current++;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="attr">type</span>: <span class="string">&#x27;StringLiteral&#x27;</span>,</span><br><span class="line">                <span class="attr">value</span>: token.<span class="property">value</span>,</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 接下来我们将寻找CalExpressions, 我们从碰到开括号`(`开始</span></span><br><span class="line">        <span class="keyword">if</span>( token.<span class="property">type</span> === <span class="string">&#x27;paren&#x27;</span> &amp;&amp; token.<span class="property">value</span> === <span class="string">&#x27;(&#x27;</span>)&#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 还记得吗? 上面我们在组成tokens的时候,</span></span><br><span class="line">            <span class="comment">// 如果遇到字符串,需要忽略第一个和最后一个 `&quot;`</span></span><br><span class="line">            <span class="comment">// 这里也一样,我们只关心括号内的内容,不需要存入括号本身</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//跳过括号</span></span><br><span class="line">            token = tokens[++current];</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 我们创建了一个类型为&#x27; CallExpression &#x27;的基节点，</span></span><br><span class="line">            <span class="comment">// 我们将其名称设置为当前令牌的值，</span></span><br><span class="line">            <span class="comment">// 因为开括号后的下一个令牌是函数的名称。</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">let</span> node = &#123;</span><br><span class="line">                <span class="attr">type</span>: <span class="string">&#x27;CallExpression&#x27;</span>,</span><br><span class="line">                <span class="attr">name</span>: token.<span class="property">value</span>,</span><br><span class="line">                <span class="attr">params</span>: [],</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 我们移动current跳过函数名name</span></span><br><span class="line">            token = tokens[++current];</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 现在我们要循环遍历每一个token,这些token将是CallExpression的params</span></span><br><span class="line">            <span class="comment">// 知道我们遇到一个闭括号 `)`</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 我们将依靠递归来求解。而不是试图解析一组可能无限嵌套的节点</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//为了解释这一点，让我们以我们的Lisp代码为例。你可以看到&#x27; add &#x27;的参数是一个数字和一个嵌套的&#x27; CallExpression &#x27;，其中包括它自己的数字。</span></span><br><span class="line">            <span class="comment">// (add 2 (subtract 4 2))</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            [</span></span><br><span class="line"><span class="comment">                &#123; type: &#x27;paren&#x27;, value: &#x27;(&#x27; &#125;,</span></span><br><span class="line"><span class="comment">                &#123; type: &#x27;name&#x27;, value: &#x27;add&#x27; &#125;,</span></span><br><span class="line"><span class="comment">                &#123; type: &#x27;number&#x27;, value: &#x27;2&#x27; &#125;,</span></span><br><span class="line"><span class="comment">                &#123; type: &#x27;paren&#x27;, value: &#x27;(&#x27; &#125;,</span></span><br><span class="line"><span class="comment">                &#123; type: &#x27;name&#x27;, value: &#x27;subtract&#x27; &#125;,</span></span><br><span class="line"><span class="comment">                &#123; type: &#x27;number&#x27;, value: &#x27;4&#x27; &#125;,</span></span><br><span class="line"><span class="comment">                &#123; type: &#x27;number&#x27;, value: &#x27;2&#x27; &#125;,</span></span><br><span class="line"><span class="comment">                &#123; type: &#x27;paren&#x27;, value: &#x27;)&#x27; &#125;,</span></span><br><span class="line"><span class="comment">                &#123; type: &#x27;paren&#x27;, value: &#x27;)&#x27; &#125;</span></span><br><span class="line"><span class="comment">            ]</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 我们将会依靠嵌套walk()函数来移动current指针变量遍历所有嵌套的`CallExpression`</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 因此我们执行一个while循环持续添加token到params中作为参数</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(</span><br><span class="line">                (token.<span class="property">type</span> !== <span class="string">&#x27;paren&#x27;</span>) || </span><br><span class="line">                (token.<span class="property">type</span> === <span class="string">&#x27;paren&#x27;</span> &amp;&amp; token.<span class="property">value</span> !== <span class="string">&#x27;)&#x27;</span>)</span><br><span class="line">            )&#123;</span><br><span class="line">                <span class="comment">// 我们将调用walk()函数返回一个节点,并把它push到node.params中</span></span><br><span class="line">                node.<span class="property">params</span>.<span class="title function_">push</span>(<span class="title function_">walk</span>())</span><br><span class="line">                token = tokens[current];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 参数遍历完毕,我们最后移动current一次来跳过右括号 `)`</span></span><br><span class="line">            current++;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 返回这个函数node</span></span><br><span class="line">            <span class="keyword">return</span> node;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如上,如果我们到现在还有未识别的token,就抛出一个错误</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TypeError</span>(token.<span class="property">type</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 现在,我们将要从一个type为Program的根节点开始创建我们的AST</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> ast = &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&quot;Program&quot;</span>,</span><br><span class="line">        <span class="attr">body</span>: [],</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 然后我们启动walk()函数把节点都push到ast.body数组中</span></span><br><span class="line">    <span class="comment">// 我们在循环中这样做的原因是我们的程序可以一个接一个地使用“CallExpression”，而不是被嵌套。</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(current &lt; tokens.<span class="property">length</span>)&#123;</span><br><span class="line">        ast.<span class="property">body</span>.<span class="title function_">push</span>(<span class="title function_">walk</span>())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 最后返回所生成的AST</span></span><br><span class="line">    <span class="keyword">return</span> ast;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ============================================================================</span></span><br><span class="line"><span class="comment"> *                                 ⌒(❀&gt;◞౪◟&lt;❀)⌒</span></span><br><span class="line"><span class="comment"> *                               THE TRAVERSER!!!</span></span><br><span class="line"><span class="comment"> * ============================================================================</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 现在我们有了AST,并且我们希望能够访问不同的节点. </span></span><br><span class="line"><span class="comment">// 我们需要能够在遇到匹配类型的节点时调用访问器上的方法</span></span><br><span class="line"><span class="comment">/*  *  traverse(ast, &#123;</span></span><br><span class="line"><span class="comment">    *     Program: &#123;</span></span><br><span class="line"><span class="comment">    *       enter(node, parent) &#123;</span></span><br><span class="line"><span class="comment">    *         // ...</span></span><br><span class="line"><span class="comment">    *       &#125;,</span></span><br><span class="line"><span class="comment">    *       exit(node, parent) &#123;</span></span><br><span class="line"><span class="comment">    *         // ...</span></span><br><span class="line"><span class="comment">    *       &#125;,</span></span><br><span class="line"><span class="comment">    *     &#125;,</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    *     CallExpression: &#123;</span></span><br><span class="line"><span class="comment">    *       enter(node, parent) &#123;</span></span><br><span class="line"><span class="comment">    *         // ...</span></span><br><span class="line"><span class="comment">    *       &#125;,</span></span><br><span class="line"><span class="comment">    *       exit(node, parent) &#123;</span></span><br><span class="line"><span class="comment">    *         // ...</span></span><br><span class="line"><span class="comment">    *       &#125;,</span></span><br><span class="line"><span class="comment">    *     &#125;,</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    *     NumberLiteral: &#123;</span></span><br><span class="line"><span class="comment">    *       enter(node, parent) &#123;</span></span><br><span class="line"><span class="comment">    *         // ...</span></span><br><span class="line"><span class="comment">    *       &#125;,</span></span><br><span class="line"><span class="comment">    *       exit(node, parent) &#123;</span></span><br><span class="line"><span class="comment">    *         // ...</span></span><br><span class="line"><span class="comment">    *       &#125;,</span></span><br><span class="line"><span class="comment">    *     &#125;,</span></span><br><span class="line"><span class="comment">    *   &#125;);</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 因此我们定义了一个traverser函数来接收一个AST,和一个visitor</span></span><br><span class="line"><span class="comment">// 在访问器函数内我们需要定义两个函数...</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">traverser</span>(<span class="params">ast, visitor</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 定义一个&#x27; traverseArray &#x27;函数，它允许我们遍历一个数组，</span></span><br><span class="line">    <span class="comment">// 并调用我们将定义的下一个函数:&#x27; traverseNode &#x27;。</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">traverseArray</span>(<span class="params">array, parent</span>) &#123;</span><br><span class="line">        array.<span class="title function_">forEach</span>(<span class="function"><span class="params">child</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="title function_">traverserNode</span>(child, parent);</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 定义一个&#x27; traverseNode &#x27;函数,接收一个node和它的父节点parent,</span></span><br><span class="line">    <span class="comment">// 这样可以把他俩都传递给我们的访问器方法</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">traverseNode</span>(<span class="params">node, parent</span>)&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 我们首先测试访问器上是否存在一个具有匹配“类型”的方法。</span></span><br><span class="line">        <span class="keyword">let</span> mothods = visitor[node.<span class="property">type</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果对于此节点存在匹配的方法,我们就调用它</span></span><br><span class="line">        <span class="keyword">if</span>(methods &amp;&amp; methods.<span class="property">enter</span>)&#123;</span><br><span class="line">            methods.<span class="title function_">enter</span>(node, parent);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 接下来我们按照节点类型进行拆分</span></span><br><span class="line">        <span class="keyword">switch</span>(node.<span class="property">type</span>)&#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 我们将从顶层的“Program”开始。</span></span><br><span class="line">            <span class="comment">// 由于程序节点有一个名为body的属性，该属性有一个节点数组，</span></span><br><span class="line">            <span class="comment">// 我们将调用&#x27; traverseArray &#x27;向下遍历它们。</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// (请记住，&#x27; traverseArray &#x27;将依次调用&#x27; traverseNode&#x27;，</span></span><br><span class="line">            <span class="comment">// 因此我们将导致AST被递归遍历</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;Program&#x27;</span>:</span><br><span class="line">                <span class="title function_">traverseArray</span>(node.<span class="property">body</span>, node);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 接下来对 `CallExpression`做同样的事并遍历其params</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;CallExpression&#x27;</span>:</span><br><span class="line">                <span class="title function_">traverseArray</span>(node.<span class="property">params</span>, node);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 对于`NumberLiteral` 和 `StringLiteral`,没有子节点需要访问,所以直接break</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;NumberLiteral&#x27;</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;StringLiteral&#x27;</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 同样,如果没有识别到该类型则抛出错误</span></span><br><span class="line">            <span class="attr">default</span>:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TypeError</span>(node.<span class="property">type</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果该节点类型有一个“exit”方法，我们将用“node”和它的“parent”来调用它。</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(methods &amp;&amp; methods.<span class="property">exit</span>)&#123;</span><br><span class="line">            methods.<span class="title function_">exit</span>(node, parent)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 最后我们通过对ast调用traverseNode来启动,ast没有父节点,所以传入null</span></span><br><span class="line">    <span class="title function_">traverseNode</span>(ast, <span class="literal">null</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ============================================================================</span></span><br><span class="line"><span class="comment"> *                                   ⁽(◍˃̵͈̑ᴗ˂̵͈̑)⁽</span></span><br><span class="line"><span class="comment"> *                              THE TRANSFORMER!!!</span></span><br><span class="line"><span class="comment"> * ============================================================================</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// 接下来是转化器。我们的转换器将获取我们已经构建的AST，</span></span><br><span class="line"><span class="comment">// 并将其传递给带有visitor的遍历函数，并将创建一个新的AST。</span></span><br><span class="line"><span class="comment">/*----------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"> *   Original AST                     |   Transformed AST</span></span><br><span class="line"><span class="comment"> * ----------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"> *   &#123;                                |   &#123;</span></span><br><span class="line"><span class="comment"> *     type: &#x27;Program&#x27;,               |     type: &#x27;Program&#x27;,</span></span><br><span class="line"><span class="comment"> *     body: [&#123;                       |     body: [&#123;</span></span><br><span class="line"><span class="comment"> *       type: &#x27;CallExpression&#x27;,      |       type: &#x27;ExpressionStatement&#x27;,</span></span><br><span class="line"><span class="comment"> *       name: &#x27;add&#x27;,                 |       expression: &#123;</span></span><br><span class="line"><span class="comment"> *       params: [&#123;                   |         type: &#x27;CallExpression&#x27;,</span></span><br><span class="line"><span class="comment"> *         type: &#x27;NumberLiteral&#x27;,     |         callee: &#123;</span></span><br><span class="line"><span class="comment"> *         value: &#x27;2&#x27;                 |           type: &#x27;Identifier&#x27;,</span></span><br><span class="line"><span class="comment"> *       &#125;, &#123;                         |           name: &#x27;add&#x27;</span></span><br><span class="line"><span class="comment"> *         type: &#x27;CallExpression&#x27;,    |         &#125;,</span></span><br><span class="line"><span class="comment"> *         name: &#x27;subtract&#x27;,          |         arguments: [&#123;</span></span><br><span class="line"><span class="comment"> *         params: [&#123;                 |           type: &#x27;NumberLiteral&#x27;,</span></span><br><span class="line"><span class="comment"> *           type: &#x27;NumberLiteral&#x27;,   |           value: &#x27;2&#x27;</span></span><br><span class="line"><span class="comment"> *           value: &#x27;4&#x27;               |         &#125;, &#123;</span></span><br><span class="line"><span class="comment"> *         &#125;, &#123;                       |           type: &#x27;CallExpression&#x27;,</span></span><br><span class="line"><span class="comment"> *           type: &#x27;NumberLiteral&#x27;,   |           callee: &#123;</span></span><br><span class="line"><span class="comment"> *           value: &#x27;2&#x27;               |             type: &#x27;Identifier&#x27;,</span></span><br><span class="line"><span class="comment"> *         &#125;]                         |             name: &#x27;subtract&#x27;</span></span><br><span class="line"><span class="comment"> *       &#125;]                           |           &#125;,</span></span><br><span class="line"><span class="comment"> *     &#125;]                             |           arguments: [&#123;</span></span><br><span class="line"><span class="comment"> *   &#125;                                |             type: &#x27;NumberLiteral&#x27;,</span></span><br><span class="line"><span class="comment"> *                                    |             value: &#x27;4&#x27;</span></span><br><span class="line"><span class="comment"> * ---------------------------------- |           &#125;, &#123;</span></span><br><span class="line"><span class="comment"> *                                    |             type: &#x27;NumberLiteral&#x27;,</span></span><br><span class="line"><span class="comment"> *                                    |             value: &#x27;2&#x27;</span></span><br><span class="line"><span class="comment"> *                                    |           &#125;]</span></span><br><span class="line"><span class="comment"> *  (sorry the other one is longer.)  |         &#125;</span></span><br><span class="line"><span class="comment"> *                                    |       &#125;</span></span><br><span class="line"><span class="comment"> *                                    |     &#125;]</span></span><br><span class="line"><span class="comment"> *                                    |   &#125;</span></span><br><span class="line"><span class="comment"> * ----------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 所以我们创建一个接收lispAST的转化器函数</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">transformer</span>(<span class="params">ast</span>)&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 接下来我们将创建一个新AST,它像我们之前创建的AST一样,有一个Program节点</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> newAst = &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;Program&#x27;</span>,</span><br><span class="line">        <span class="attr">body</span>: [],</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 接下来我要耍点小聪明，创建一个小hack。</span></span><br><span class="line">    <span class="comment">// 我们将在父节点上使用名为context的属性我们将把节点推到它们的父节点的context中。</span></span><br><span class="line">    <span class="comment">// 通常你会有一个比这个更好的抽象，但为了我们的目的，这样可以使事情简单。</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 请注意，context是一个从旧ast到新ast的引用。</span></span><br><span class="line">    <span class="comment">// 意味着我们在旧ast上操作context,实际上也在操作新ast的body</span></span><br><span class="line">    ast.<span class="property">_context</span> = newAst.<span class="property">body</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 我们从一个traverser函数开始,传入一个旧ast和一个visitor</span></span><br><span class="line">    <span class="title function_">traverser</span>(ast, &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 第一个访问器方法接收所有的NumberLiteral</span></span><br><span class="line">        <span class="title class_">NumberLiteral</span>: &#123;</span><br><span class="line">            <span class="title function_">enter</span>(<span class="params">node, parent</span>)&#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//我们将创建一个同样名为&#x27; NumberLiteral &#x27;的新节点，我们将把它push到父上下文context。</span></span><br><span class="line">                parent.<span class="property">_context</span>.<span class="title function_">push</span>(&#123;</span><br><span class="line">                    <span class="attr">type</span>: <span class="string">&#x27;NumberLiteral&#x27;</span>,</span><br><span class="line">                    <span class="attr">value</span>: node.<span class="property">value</span></span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 接下来是`StringLiteral`</span></span><br><span class="line">        <span class="title class_">StringLiteral</span>: &#123;</span><br><span class="line">            <span class="title function_">enter</span>(<span class="params">node, parent</span>)&#123;</span><br><span class="line">                parent.<span class="property">_context</span>.<span class="title function_">push</span>(&#123;</span><br><span class="line">                    <span class="attr">type</span>: <span class="string">&#x27;StringLiteral&#x27;</span>,</span><br><span class="line">                    <span class="attr">value</span>: node.<span class="property">value</span>,</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 然后是`CallExpression`</span></span><br><span class="line">        <span class="title class_">CallExpression</span>: &#123;</span><br><span class="line">            <span class="title function_">enter</span>(<span class="params">node, parent</span>)&#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 我们开始创建一个带有嵌套的`Identifier`的新`CallExpression`节点</span></span><br><span class="line">                <span class="keyword">let</span> expression = &#123;</span><br><span class="line">                    <span class="attr">type</span>: <span class="string">&#x27;CallExpression&#x27;</span>,</span><br><span class="line">                    <span class="attr">callee</span>: &#123;</span><br><span class="line">                        <span class="attr">type</span>: <span class="string">&#x27;Identifier&#x27;</span>,</span><br><span class="line">                        <span class="attr">name</span>: node.<span class="property">name</span>,</span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="attr">arguments</span>: [],</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// * 接下来我们将在原`CallExpression`定义一个新的上下文,</span></span><br><span class="line">                <span class="comment">// 他将引用expression的参数,以便我们可以push参数(著名的函数作用域)</span></span><br><span class="line">                node.<span class="property">_context</span> = expression.<span class="property">arguments</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 然后我们将要检查父节点是否为`CallExpression`.</span></span><br><span class="line">                <span class="comment">// 如果不是...</span></span><br><span class="line">                <span class="keyword">if</span>(parent.<span class="property">type</span> !== <span class="string">&#x27;CallExpression&#x27;</span>)&#123;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 我们要用一个&quot; ExpressionStatement &quot;来包装&quot; CallExpression &quot;节点。</span></span><br><span class="line">                    <span class="comment">// 我们这样做是因为JavaScript中的顶层&#x27; CallExpression &#x27;实际上是语句。</span></span><br><span class="line">                    expression = &#123;</span><br><span class="line">                        <span class="attr">type</span>: <span class="string">&#x27;ExpressionStatement&#x27;</span>,</span><br><span class="line">                        <span class="attr">expression</span>: expression,</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 最后，我们push我们的(可能是包装好的)&#x27; CallExpression &#x27;到parent的“上下文”。</span></span><br><span class="line">                parent.<span class="property">_context</span>.<span class="title function_">push</span>(expression);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//在我们的transformer函数结束时，我们将返回我们刚刚创建的新ast。</span></span><br><span class="line">    <span class="keyword">return</span> newAst;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ============================================================================</span></span><br><span class="line"><span class="comment"> *                               ヾ（〃＾∇＾）ﾉ♪</span></span><br><span class="line"><span class="comment"> *                            THE CODE GENERATOR!!!!</span></span><br><span class="line"><span class="comment"> * ============================================================================</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// 现在,让我们进入最后一个阶段: 代码生成器</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//我们的代码生成器将会递归自调用,将AST中每个节点打印成一个巨大的字符串</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">codeGenerator</span>(<span class="params">node</span>)&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 我们将按照节点的类型来分解</span></span><br><span class="line">    <span class="keyword">switch</span>(node.<span class="property">type</span>)&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果我们有一个&#x27; Program &#x27;节点。我们将映射“body”中的每个节点，</span></span><br><span class="line">        <span class="comment">// 并通过代码生成器运行它们，并用换行符将它们连接起来。</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;Program&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> node.<span class="property">body</span>.<span class="title function_">map</span>(codeGenerator) <span class="comment">//等同于.map(item =&gt; codeGenerator(item))</span></span><br><span class="line">                .<span class="title function_">join</span>(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 对于&#x27; ExpressionStatement &#x27;，我们将调用嵌套表达式上的代码生成器，并添加一个分号…</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;ExpressionStatement&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> (</span><br><span class="line">                <span class="title function_">codeGenerator</span>(node.<span class="property">expression</span>) + <span class="string">&#x27;;&#x27;</span></span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 对于&#x27;CallExpression&#x27;，我们将打印&#x27;callee&#x27;，添加一个开括号，映射&#x27; arguments &#x27;数组中的每个节点，</span></span><br><span class="line">        <span class="comment">// 并在代码生成器中运行它们，用逗号连接它们，然后我们将添加一个闭括号。</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;CallExpression&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> (</span><br><span class="line">                <span class="title function_">codeGenerator</span>(node.<span class="property">callee</span>) +</span><br><span class="line">                <span class="string">&#x27;(&#x27;</span> + </span><br><span class="line">                node.<span class="property">arguments</span>.<span class="title function_">map</span>(codeGenerator)</span><br><span class="line">                    .<span class="title function_">join</span>(<span class="string">&#x27;, &#x27;</span>) + </span><br><span class="line">                <span class="string">&#x27;)&#x27;</span></span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 对于`Indentifier`,只需要return节点的name</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;Indentifier&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> node.<span class="property">name</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 对于`NumberLiteral`,只需return节点的value</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;NumberLiteral&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> node.<span class="property">value</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 对于`StringLiteral`,只需要给节点的value包裹双引号</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;StringLiteral&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;&quot;&#x27;</span> + node.<span class="property">value</span> + <span class="string">&#x27;&quot;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 最后如果有没有识别到的node, 就抛出错误</span></span><br><span class="line">        <span class="attr">default</span>:</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TypeError</span>(node.<span class="property">type</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ============================================================================</span></span><br><span class="line"><span class="comment"> *                                  (۶* ‘ヮ’)۶”</span></span><br><span class="line"><span class="comment"> *                         !!!!!!!!THE COMPILER!!!!!!!!</span></span><br><span class="line"><span class="comment"> * ============================================================================</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//  终于!我们将创建“compiler”函数。在这里，我们将把管道的每个部分连接在一起。</span></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> *   1. input  =&gt; tokenizer   =&gt; tokens</span></span><br><span class="line"><span class="comment"> *   2. tokens =&gt; parser      =&gt; ast</span></span><br><span class="line"><span class="comment"> *   3. ast    =&gt; transformer =&gt; newAst</span></span><br><span class="line"><span class="comment"> *   4. newAst =&gt; generator   =&gt; output</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">compiler</span>(<span class="params">input</span>)&#123;</span><br><span class="line">    <span class="keyword">let</span> tokens = <span class="title function_">tokenizer</span>(input);</span><br><span class="line">    <span class="keyword">let</span> ast    = <span class="title function_">parser</span>(tokens);</span><br><span class="line">    <span class="keyword">let</span> newAst = <span class="title function_">transformer</span>(ast);</span><br><span class="line">    <span class="keyword">let</span> output = <span class="title function_">codeGenerator</span>(newAst);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> output;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ============================================================================</span></span><br><span class="line"><span class="comment"> *                                   (๑˃̵ᴗ˂̵)و</span></span><br><span class="line"><span class="comment"> * !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!YOU MADE IT!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span></span><br><span class="line"><span class="comment"> * ============================================================================</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Now I&#x27;m just exporting everything...</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    tokenizer,</span><br><span class="line">    parser,</span><br><span class="line">    traverser,</span><br><span class="line">    transformer,</span><br><span class="line">    codeGenerator,</span><br><span class="line">    compiler,</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>
<h2 id="总结一下"><a class="markdownIt-Anchor" href="#总结一下">#</a> 总结一下</h2>
<p>代码编译器的工作可以分为三个阶段：Parse、Transformation 和 Code Generation。</p>
<ol>
<li>
<p><strong>Parse</strong> 阶段：代码编译器首先会将源代码转换成抽象语法树（AST），这个过程称为 Parse。Parse 的过程可以分为词法分析和语法分析两个阶段。在词法分析阶段，编译器会将源代码分解成一个个的 Token，然后将这些 Token 组成 Token 流；在语法分析阶段，编译器会将 Token 流转换成 AST。</p>
</li>
<li>
<p><strong>Transformation</strong> 阶段：在 Transformation 阶段，编译器会对 AST 进行一系列的变换，例如删除无用代码、优化代码结构等。这个过程也被称为 “中间代码生成”。</p>
</li>
<li>
<p><strong>Code Generation</strong> 阶段：在 Code Generation 阶段，编译器会将 AST 转换成目标代码，这个过程也被称为 “后端代码生成”。Code Generation 过程中涉及到的技术包括指令选择、寄存器分配等。</p>
</li>
</ol>
<p>总之，代码编译器的工作是将源代码转换成目标代码的过程，它包括 Parse、Transformation 和 Code Generation 三个阶段。每个阶段都会对代码进行一些特定的操作，最终生成可执行的目标代码。</p>

      <div class="tags">
          <a href="/tags/JS/" rel="tag"><i class="ic i-tag"></i> JS</a>
      </div>
  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">更新于</span>
    <time title="修改时间：2023-03-24 22:32:06" itemprop="dateModified" datetime="2023-03-24T22:32:06+08:00">2023-03-24</time>
  </span>
  <span id="js/js-basic/The Super Tiny Complier/" class="item leancloud_visitors" data-flag-title="迷你编译器" title="阅读次数">
      <span class="icon">
        <i class="ic i-eye"></i>
      </span>
      <span class="text">阅读次数</span>
      <span class="leancloud-visitors-count"></span>
      <span class="text">次</span>
  </span>
</div>

      
<div class="reward">
  <button><i class="ic i-heartbeat"></i> 赞赏</button>
  <p>请我喝[茶]~(￣▽￣)~*</p>
  <div id="qr">
      
      <div>
        <img data-src="/images/wechatpay.png" alt="寂林 微信支付">
        <p>微信支付</p>
      </div>
      
      <div>
        <img data-src="/images/alipay.png" alt="寂林 支付宝">
        <p>支付宝</p>
      </div>
  </div>
</div>

      

<div id="copyright">
<ul>
  <li class="author">
    <strong>本文作者： </strong>寂林 <i class="ic i-at"><em>@</em></i>寂林的小窝
  </li>
  <li class="link">
    <strong>本文链接：</strong>
    <a href="https://jilinjl.github.io/js/js-basic/The%20Super%20Tiny%20Complier/" title="迷你编译器">https://jilinjl.github.io/js/js-basic/The Super Tiny Complier/</a>
  </li>

</ul>
</div>

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
      

  <a href="/data-structure/7.%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84--%E5%AD%97%E5%85%B8/" itemprop="url" rel="prev" data-background-image="http:&#x2F;&#x2F;imgapi.xl0408.top&#x2F;index.php?469752" title="JS数据结构-字典">
  <span class="type">上一篇</span>
  <span class="category"><i class="ic i-flag"></i> 数据结构</span>
  <h3>JS数据结构-字典</h3>
  </a>

    </div>
    <div class="item right">
      

  <a href="/something/%E4%BA%91%E5%BE%99%E7%A7%91%E6%8A%80/" itemprop="url" rel="next" data-background-image="http:&#x2F;&#x2F;imgapi.xl0408.top&#x2F;index.php?321203" title="实习第一天">
  <span class="type">下一篇</span>
  <span class="category"><i class="ic i-flag"></i> something</span>
  <h3>实习第一天</h3>
  </a>

    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="文章目录">
          <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#the-super-tiny-complier"><span class="toc-number">1.</span> <span class="toc-text"> The Super Tiny Complier</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#parsing-%E8%A7%A3%E6%9E%90"><span class="toc-number">1.1.</span> <span class="toc-text"> Parsing 解析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#transformation-%E8%BD%AC%E5%8C%96"><span class="toc-number">1.2.</span> <span class="toc-text"> Transformation 转化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#traversal-%E9%81%8D%E5%8E%86"><span class="toc-number">1.2.1.</span> <span class="toc-text"> Traversal  遍历</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#visitors-%E8%AE%BF%E9%97%AE%E5%99%A8"><span class="toc-number">1.2.2.</span> <span class="toc-text"> Visitors 访问器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#code-generation-%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90"><span class="toc-number">1.3.</span> <span class="toc-text"> Code Generation 代码生成</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#tiny-complier"><span class="toc-number">2.</span> <span class="toc-text"> Tiny Complier</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E6%96%B9%E9%AB%98%E8%83%BD"><span class="toc-number">2.1.</span> <span class="toc-text"> 前方高能！！</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93%E4%B8%80%E4%B8%8B"><span class="toc-number">2.2.</span> <span class="toc-text"> 总结一下</span></a></li></ol></li></ol>
      </div>
      <div class="related panel pjax" data-title="系列文章">
        <ul>
          <li><a href="/js/js-basic/JS%E5%9F%BA%E7%A1%80/" rel="bookmark" title="JS基础啦">JS基础啦</a></li><li><a href="/js/js-basic/JavaScript%20%E9%9D%A2%E8%AF%95%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93/" rel="bookmark" title="JS面试知识点">JS面试知识点</a></li><li class="active"><a href="/js/js-basic/The%20Super%20Tiny%20Complier/" rel="bookmark" title="迷你编译器">迷你编译器</a></li>
        </ul>
      </div>
      <div class="overview panel" data-title="站点概览">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="寂林"
      data-src="/images/avatar.jpg">
  <p class="name" itemprop="name">寂林</p>
  <div class="description" itemprop="description">飒飒西风满院栽,蕊寒香冷蝶难来</div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">26</span>
        <span class="name">文章</span>
      </a>
    </div>
    <div class="item categories">
      <a href="/categories/">
        <span class="count">10</span>
        <span class="name">分类</span>
      </a>
    </div>
    <div class="item tags">
      <a href="/tags/">
        <span class="count">14</span>
        <span class="name">标签</span>
      </a>
    </div>
</nav>

<div class="social">
      <span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL2ppbGluSkw=" title="https:&#x2F;&#x2F;github.com&#x2F;jilinJL"><i class="ic i-github"></i></span>
      <span class="exturl item zhihu" data-url="aHR0cHM6Ly93d3cuemhpaHUuY29tL3Blb3BsZS9qaS1saW4tamw=" title="https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;ji-lin-jl"><i class="ic i-zhihu"></i></span>
      <span class="exturl item music" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLyMvdXNlci9ob21lP2lkPTQwOTkyMTIzOQ==" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;409921239"><i class="ic i-cloud-music"></i></span>
      <span class="exturl item email" data-url="bWFpbHRvOndvc2hpamlsaW5AZm94bWFpbC5jb20=" title="mailto:woshijilin@foxmail.com"><i class="ic i-envelope"></i></span>
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>首页</a>
  </li>

    
  <li class="item">
    <a href="/about/" rel="section"><i class="ic i-user"></i>关于</a>
  </li>

        
  <li class="item dropdown">
      <a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a>
    <ul class="submenu">

        
  <li class="item">
    <a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a>
  </li>

        
  <li class="item">
    <a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a>
  </li>

        
  <li class="item">
    <a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a>
  </li>

  </ul>
    
  <li class="item">
    <a href="/friends/" rel="section"><i class="ic i-heart"></i>friends</a>
  </li>

    
  <li class="item">
    <a href="/links/" rel="section"><i class="ic i-magic"></i>links</a>
  </li>


</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
        <a href="/data-structure/7.%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84--%E5%AD%97%E5%85%B8/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a>
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
        <a href="/something/%E4%BA%91%E5%BE%99%E7%A7%91%E6%8A%80/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a>
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          
<div class="rpost pjax">
  <h2>随机文章</h2>
  <ul>
      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/react/" title="分类于 React">React</a>
</div>

    <span><a href="/react/React/" title="React基础">React基础</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/javaweb/" title="分类于 JavaWeb">JavaWeb</a>
</div>

    <span><a href="/javaweb/Javaweb%E9%A1%B9%E7%9B%AE%E5%9F%BA%E7%A1%80/" title="Javaweb项目基础">Javaweb项目基础</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/javaweb/" title="分类于 JavaWeb">JavaWeb</a>
</div>

    <span><a href="/javaweb/%E9%A5%BF%E4%BA%86%E4%B9%88%E9%A1%B9%E7%9B%AE%E6%8E%A5%E5%8F%A3%E5%AE%9E%E7%8E%B0/" title="饿了么项目接口实现_更新ing">饿了么项目接口实现_更新ing</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/data-structure/" title="分类于 数据结构">数据结构</a>
</div>

    <span><a href="/data-structure/2.%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84--%E9%98%9F%E5%88%97/" title="JS数据结构-队列">JS数据结构-队列</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/js/" title="分类于 JavaScript">JavaScript</a>
<i class="ic i-angle-right"></i>
<a href="/categories/js/js-basic/" title="分类于 JS基础">JS基础</a>
</div>

    <span><a href="/js/js-basic/JavaScript%20%E9%9D%A2%E8%AF%95%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93/" title="JS面试知识点">JS面试知识点</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/something/" title="分类于 something">something</a>
</div>

    <span><a href="/something/OBS%E8%99%9A%E6%8B%9F%E6%91%84%E5%83%8F%E5%A4%B4%E4%BD%BF%E7%94%A8/" title="OBS虚拟摄像头">OBS虚拟摄像头</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/data-structure/" title="分类于 数据结构">数据结构</a>
</div>

    <span><a href="/data-structure/6.%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84--%E9%9B%86%E5%90%88/" title="JS数据结构-集合">JS数据结构-集合</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/js/" title="分类于 JavaScript">JavaScript</a>
<i class="ic i-angle-right"></i>
<a href="/categories/js/es6/" title="分类于 浅试一下ES6+">浅试一下ES6+</a>
</div>

    <span><a href="/js/es6/ES6-%E5%85%9C%E5%85%9C%E8%BD%AC%E8%BD%AC%E8%BF%98%E6%98%AF%E4%BD%A0/" title="ES6">ES6</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/demo/" title="demo">demo</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/js/" title="分类于 JavaScript">JavaScript</a>
<i class="ic i-angle-right"></i>
<a href="/categories/js/design-patterns/" title="分类于 JS设计模式">JS设计模式</a>
</div>

    <span><a href="/js/design-patterns/JS%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" title="JS设计模式">JS设计模式</a></span>
  </li>

  </ul>
</div>
<div>
  <h2>最新评论</h2>
  <ul class="leancloud-recent-comment"></ul>
</div>

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2022 – 
    <span itemprop="copyrightYear">2023</span>
    <span class="with-love">
      <i class="ic i-Jilin"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">寂林 @ Welcome</span>
  </div>

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  <div class="count">
    <span class="post-meta-item-icon">
      <i class="ic i-chart-area"></i>
    </span>
    <span title="站点总字数">218k 字</span>

    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="ic i-coffee"></i>
    </span>
    <span title="站点阅读时长">3:18</span>
  </div>


        <!-- 不蒜子统计 -->
        <span id="busuanzi_container_site_pv">
                本站总访问量<span id="busuanzi_value_site_pv"></span>次
        </span>
        <span class="post-meta-divider">|</span>
                本站访客数<span id="busuanzi_value_site_uv"></span>人
        </span>
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>



      </div>
    </footer>
  </div>
<script data-config type="text/javascript">
  var LOCAL = {
    path: 'js/js-basic/The Super Tiny Complier/',
    favicon: {
      show: "（●´3｀●）やれやれだぜ",
      hide: "(´Д｀)大変だ！"
    },
    search : {
      placeholder: "文章搜索",
      empty: "关于 「 ${query} 」，什么也没搜到",
      stats: "${time} ms 内找到 ${hits} 条结果"
    },
    valine: true,fancybox: true,
    copyright: '复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>

<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>

<script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>

<script src="/js/app.js?v=0.2.5"></script>




</body>
</html>
